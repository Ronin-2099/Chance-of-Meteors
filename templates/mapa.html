<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Interactive Map of Impact</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #1a1a2e;
            color: #e0e0e0;
            margin: 0;
            padding: 0;
        }
        h1 {
            text-align: center;
            color: #e0e0e0;
            margin-top: 20px;
        }
        /* Contenedor principal para toda la aplicación */
        .main-container {
            width: 90%;
            max-width: 1000px;
            margin: 30px auto;
            padding: 20px;
            background-color: #2a2a4a;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
        }
        /* Estilo del mapa */
        #map {
            height: 500px;
            width: 100%;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            margin-bottom: 20px;
        }
        /* Estilos para los controles */
        .controls {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        .controls label {
            display: block;
            margin-bottom: 5px;
            font-size: 0.9em;
        }
        .controls input, .controls select, .controls button {
            width: 100%;
            padding: 10px;
            box-sizing: border-box;
            border: 1px solid #4a4a6a;
            border-radius: 4px;
            background-color: #3a3a5a;
            color: #e0e0e0;
            font-size: 1em;
        }
        .controls button {
            background-color: #007bff;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        .controls button:hover {
            background-color: #0056b3;
        }
        .wide {
            grid-column: 1 / -1; /* Ocupa todo el ancho */
        }
        .hint {
            font-size: 0.85rem;
            color: #aaa;
            margin-top: 6px;
            text-align: center;
        }
        /* Estilos para la sección de resultados */
        .results {
            margin-top: 20px;
            padding: 15px;
            background-color: #1a1a2e;
            border: 1px solid #4a4a6a;
            border-radius: 4px;
        }
        .results strong {
            color: #00aaff;
        }
        .results ul {
            list-style-type: none;
            padding: 0;
            margin-top: 10px;
        }
        .results li {
            padding: 4px 0;
        }
        /* Estilo para el enlace de regreso */
        .back-link {
            display: block;
            text-align: center;
            margin: -10px 0 20px 0;
            font-size: 1.1em;
        }
        .back-link a {
            color: #00aaff;
            text-decoration: none;
        }
        .back-link a:hover {
            text-decoration: underline;
        }
    </style>
</head>
<body>
    <h1>Interactive Map of Impact ☄️</h1>
    
    <div class="back-link">
        <a href="{{ url_for('index') }}">&larr; Return to homepage</a>
    </div>

    <div class="main-container">
        <div id="map"></div>
        
        <div class="controls">
            <div>
                <label for="diameter">Asteroid's Diameter (m):</label>
                <input id="diameter" type="number" step="any" value="50" />
            </div>
            <div>
                <label for="velocity">Velocity (m/s):</label>
                <input id="velocity" type="number" step="any" value="15000" />
            </div>
            <div>
                <label for="p_crater">Asteroid's Density (kg/m³)</label>
                <input id="p_crater" type="number" step="any" value="3000" />
            </div>
            <div>
                <label for="p_surface">Surface's Density (kg/m³)</label>
                <input id="p_surface" type="number" step="any" value="1500" />
            </div>
            <div class="wide">
                <label for="terrain">Terrain ( Choice affects the "k" constant):</label>
                <select id="terrain">
                    <option value="rock">Rock</option>
                    <option value="sand" selected>Sand</option>
                    <option value="ice">Ice</option>
                    <option value="water">Water</option>
                </select>
            </div>
            <div class="wide">
                <label for="coords">Coordinates of Impact (Lat, Long):</label>
                <input id="coords" type="text" placeholder="25.6866,-100.3161" value="25.6866,-100.3161" />
            </div>
            <div class="wide">
                <button id="compute">Calculate and Draw Impact</button>
                <div class="hint">Click on the map to visualize impact.</div>
            </div>
        </div>

        <div class="results" id="results">
            <strong>Results:</strong>
            <div id="out">Results haven´t yet been calculated.</div>
        </div>
    </div>
    
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <script>
        // --- Lógica de la calculadora (sin cambios) ---
        function computeImpact(params) {
            const d = Number(params.d);
            const v = Number(params.v);
            const p_crater = Number(params.p_crater);
            const p_surface = Number(params.p_surface);
            if (!d || !v || !p_crater || !p_surface) {
                return { error: "Todos los parámetros numéricos deben ser mayores que 0." };
            }
            const m = (4/3) * Math.PI * Math.pow(d/2, 3) * p_crater;
            const E = 0.5 * m * Math.pow(v, 2);
            let k = 0.3;
            const terrain = (params.terrain || "sand").toLowerCase();
            if (terrain === 'rock') k = 0.22;
            else if (terrain === 'sand') k = 0.3;
            else if (terrain === 'ice') k = 0.5;
            else if (terrain === 'water') k = 0.6;
            const R = k * Math.pow(p_crater / p_surface, 1/3) * Math.pow(d, 0.78) * Math.pow(v, 0.44);
            const D_km = (2 * R) / 1000;
            return { d, v, p_crater, p_surface, terrain, k, mass_kg: m, energy_j: E, radius_m: R, diameter_km: D_km };
        }

        // --- Lógica del mapa y eventos ---
        document.addEventListener('DOMContentLoaded', () => {
            // === CÓDIGO NUEVO PARA LEER PARÁMETROS DE LA URL ===
            const urlParams = new URLSearchParams(window.location.search);
            const diameterParam = urlParams.get('diameter');
            const velocityParam = urlParams.get('velocity');

            if (diameterParam) {
                // Redondeamos a 2 decimales para que se vea limpio
                document.getElementById('diameter').value = parseFloat(diameterParam).toFixed(2);
            }
            if (velocityParam) {
                document.getElementById('velocity').value = parseFloat(velocityParam).toFixed(2);
            }
            // === FIN DEL CÓDIGO NUEVO ===

            const defaultCenter = [25.6866, -100.3161];
            const map = L.map('map').setView(defaultCenter, 10);

            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                maxZoom: 19,
                attribution: '&copy; OpenStreetMap contributors'
            }).addTo(map);

            let impactMarker = null;
            let impactCircle = null;

            function setImpactMarker(latlng) {
                if (impactMarker) map.removeLayer(impactMarker);
                impactMarker = L.marker(latlng).addTo(map);
            }

            function drawImpactCircle(latlng, radius_m, popupHtml) {
                if (impactCircle) map.removeLayer(impactCircle);
                impactCircle = L.circle(latlng, { radius: radius_m, weight: 2, color: 'red', fillColor: '#f03', fillOpacity: 0.2, }).addTo(map);
                if (popupHtml) impactCircle.bindPopup(popupHtml).openPopup();
                map.fitBounds(impactCircle.getBounds(), { padding: [40,40] });
            }

            map.on('click', function(e) {
                const lat = e.latlng.lat.toFixed(6);
                const lng = e.latlng.lng.toFixed(6);
                document.getElementById('coords').value = `${lat},${lng}`;
                setImpactMarker(e.latlng);
            });

            document.getElementById('compute').addEventListener('click', () => {
                const d = document.getElementById('diameter').value;
                const v = document.getElementById('velocity').value;
                const p_crater = document.getElementById('p_crater').value;
                const p_surface = document.getElementById('p_surface').value;
                const terrain = document.getElementById('terrain').value;
                const coordsText = document.getElementById('coords').value;

                const coordsParts = coordsText.split(',').map(s => s.trim()).filter(Boolean);
                if (coordsParts.length !== 2 || isNaN(Number(coordsParts[0])) || isNaN(Number(coordsParts[1]))) {
                    alert('Introduce coordenadas válidas en formato "lat,lng" o haz clic en el mapa.');
                    return;
                }
                const lat = Number(coordsParts[0]);
                const lng = Number(coordsParts[1]);

                const result = computeImpact({ d, v, p_crater, p_surface, terrain });
                const out = document.getElementById('out');

                if (result.error) {
                    out.innerHTML = `<span style="color:crimson;">Error: ${result.error}</span>`;
                    return;
                }

                const massStr = result.mass_kg.toExponential(3) + ' kg';
                const energyStr = result.energy_j.toExponential(3) + ' J';
                const diameterStr = result.diameter_km.toFixed(3) + ' km';
                const radiusStr_m = result.radius_m.toFixed(1) + ' m';

                out.innerHTML = `
                    <ul>
                        <li><strong>Damage radius (R):</strong> ${radiusStr_m}</li>
                        <li><strong>Approx. damage diameter:</strong> ${diameterStr}</li>
                        <li><strong>Kinetic energy:</strong> ${energyStr}</li>
                        <li><strong>Estimated mass:</strong> ${massStr}</li>
                    </ul>`;

                const latlng = [lat, lng];
                setImpactMarker(latlng);
                const popup = `<strong>Impact</strong><br/>Diameter of damage: ${diameterStr}<br/>Radius: ${radiusStr_m}`;
                drawImpactCircle(latlng, result.radius_m, popup);
            });

            setImpactMarker(defaultCenter);
        });
    </script>
</body>
</html>